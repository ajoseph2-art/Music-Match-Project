{% extends 'base.html' %}

{% block title %}Discovery Swipe - MusicMatch{% endblock %}

{% block extra_css %}
<style>
    .swipe-card {
        max-width: 500px;
        margin: 0 auto;
        cursor: grab;
        user-select: none;
        transition: transform 0.3s ease;
    }
    .swipe-card:active {
        cursor: grabbing;
    }
    .swipe-card.swiping-left {
        transform: rotate(-15deg) translateX(-100px);
        opacity: 0.5;
    }
    .swipe-card.swiping-right {
        transform: rotate(15deg) translateX(100px);
        opacity: 0.5;
    }
    .swipe-actions {
        margin-top: 2rem;
        text-align: center;
    }
    .song-image {
        width: 100%;
        height: 300px;
        object-fit: cover;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 4rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 text-center">
        <h1 class="display-4">Discovery Swipe</h1>
        <p class="lead">Swipe right to like, left to skip. Explore new music outside your comfort zone!</p>
        <a href="{% url 'recommendations' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Recommendations
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="swipe-card card shadow-lg" id="swipeCard">
            {% if song.image_url %}
            <img src="{{ song.image_url }}" class="card-img-top" alt="{{ song.name }}" style="height: 300px; object-fit: cover;">
            {% else %}
            <div class="song-image">
                <i class="bi bi-music-note-beamed"></i>
            </div>
            {% endif %}
            <div class="card-body text-center">
                <h2 class="card-title">{{ song.name }}</h2>
                <h4 class="text-muted">{{ song.artist }}</h4>
                {% if song.album %}
                <p class="text-muted"><em>{{ song.album }}</em></p>
                {% endif %}
                
                {% if song.genre %}
                <span class="badge bg-secondary mb-3">{{ song.genre }}</span>
                {% endif %}
                
                <div class="row mt-4">
                    {% if song.danceability is not None %}
                    <div class="col-6 mb-3">
                        <small class="text-muted d-block">Danceability</small>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" style="width: {{ song.danceability|floatformat:0 }}%">
                                {{ song.danceability|floatformat:0 }}%
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if song.energy is not None %}
                    <div class="col-6 mb-3">
                        <small class="text-muted d-block">Energy</small>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ song.energy|floatformat:0 }}%">
                                {{ song.energy|floatformat:0 }}%
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if song.valence is not None %}
                    <div class="col-6 mb-3">
                        <small class="text-muted d-block">Positivity</small>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ song.valence|floatformat:0 }}%">
                                {{ song.valence|floatformat:0 }}%
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="swipe-actions">
            <a href="{% url 'swipe_action' song.id 'skip' %}" class="btn btn-danger btn-lg me-3" id="skipBtn">
                <i class="bi bi-x-circle"></i> Skip
            </a>
            <a href="{% url 'swipe_action' song.id 'like' %}" class="btn btn-success btn-lg" id="likeBtn">
                <i class="bi bi-heart-fill"></i> Like
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Swipe functionality
    const card = document.getElementById('swipeCard');
    let startX = 0;
    let currentX = 0;
    let isDragging = false;
    
    card.addEventListener('touchstart', handleStart);
    card.addEventListener('touchmove', handleMove);
    card.addEventListener('touchend', handleEnd);
    card.addEventListener('mousedown', handleStart);
    card.addEventListener('mousemove', handleMove);
    card.addEventListener('mouseup', handleEnd);
    card.addEventListener('mouseleave', handleEnd);
    
    function handleStart(e) {
        isDragging = true;
        startX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
        card.style.transition = 'none';
    }
    
    function handleMove(e) {
        if (!isDragging) return;
        e.preventDefault();
        currentX = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
        const deltaX = currentX - startX;
        const rotation = deltaX / 10;
        
        card.style.transform = `translateX(${deltaX}px) rotate(${rotation}deg)`;
        
        if (deltaX > 50) {
            card.classList.add('swiping-right');
            card.classList.remove('swiping-left');
        } else if (deltaX < -50) {
            card.classList.add('swiping-left');
            card.classList.remove('swiping-right');
        } else {
            card.classList.remove('swiping-left', 'swiping-right');
        }
    }
    
    function handleEnd(e) {
        if (!isDragging) return;
        isDragging = false;
        card.style.transition = 'transform 0.3s ease';
        
        const deltaX = currentX - startX;
        
        if (deltaX > 100) {
            // Swipe right - like
            window.location.href = document.getElementById('likeBtn').href;
        } else if (deltaX < -100) {
            // Swipe left - skip
            window.location.href = document.getElementById('skipBtn').href;
        } else {
            // Return to center
            card.style.transform = '';
            card.classList.remove('swiping-left', 'swiping-right');
        }
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') {
            window.location.href = document.getElementById('skipBtn').href;
        } else if (e.key === 'ArrowRight') {
            window.location.href = document.getElementById('likeBtn').href;
        }
    });
</script>
{% endblock %}

